<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPG Maker MZ Class Skills Integrator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #2c3e50;
        }
        .inputs {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 20px;
        }
        textarea {
            width: 100%;
            height: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        .output-container {
            margin-top: 20px;
        }
        .output {
            width: 100%;
            height: 300px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
            background-color: #f9f9f9;
        }
        .info {
            background-color: #e7f4ff;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .stats {
            margin-top: 20px;
            padding: 15px;
            background-color: #f0f8ff;
            border-radius: 4px;
        }
        .error {
            color: red;
            font-weight: bold;
            margin-top: 10px;
        }
        .success {
            color: green;
            font-weight: bold;
            margin-top: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .preview-container {
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab-container {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
        }
        .tab {
            padding: 10px 15px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            background-color: #f1f1f1;
            margin-right: 5px;
        }
        .tab.active {
            background-color: #fff;
            border-color: #ddd;
            border-bottom-color: #fff;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>RPG Maker MZ Class Skills Integrator</h1>
        
        <div class="info">
            <p>This tool integrates extended class learnings with existing RPG Maker MZ class data. Paste your JSON inputs below and get an updated class array with integrated skills.</p>
        </div>

        <div class="tab-container">
            <div class="tab active" data-tab="input">Input</div>
            <div class="tab" data-tab="preview">Preview</div>
            <div class="tab" data-tab="output">Output</div>
        </div>

        <div class="tab-content active" data-tab-content="input">
            <div class="inputs">
                <div>
                    <h2>1. Extended Class Learnings JSON</h2>
                    <p>Paste the extended class learnings JSON (with skills up to level 99):</p>
                    <textarea id="extendedLearnings" placeholder="Paste extended class learnings JSON here..."></textarea>
                </div>
                
                <div>
                    <h2>2. Existing RPG Maker MZ Classes JSON</h2>
                    <p>Paste your existing RPG Maker MZ classes JSON:</p>
                    <textarea id="existingClasses" placeholder="Paste existing classes JSON here..."></textarea>
                </div>
            </div>
            
            <div class="controls">
                <button id="processBtn">Process and Integrate</button>
                <button id="clearBtn">Clear All</button>
            </div>
            
            <div id="messageArea"></div>
        </div>

        <div class="tab-content" data-tab-content="preview">
            <h2>Preview of Integration</h2>
            <div class="preview-container">
                <div id="previewArea">
                    <p>Process the data to see preview...</p>
                </div>
            </div>
        </div>

        <div class="tab-content" data-tab-content="output">
            <h2>Integrated Classes JSON</h2>
            <div class="output-container">
                <textarea id="outputJson" class="output" readonly placeholder="Processed JSON will appear here..."></textarea>
            </div>
            <div class="controls">
                <button id="copyBtn">Copy to Clipboard</button>
                <button id="downloadBtn">Download JSON</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Tab functionality
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs
                    tabs.forEach(t => t.classList.remove('active'));
                    // Add active class to clicked tab
                    tab.classList.add('active');
                    
                    // Hide all tab content
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // Show content for active tab
                    const tabContentId = tab.getAttribute('data-tab');
                    document.querySelector(`.tab-content[data-tab-content="${tabContentId}"]`).classList.add('active');
                });
            });
            
            // Button event listeners
            const processBtn = document.getElementById('processBtn');
            const clearBtn = document.getElementById('clearBtn');
            const copyBtn = document.getElementById('copyBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            
            processBtn.addEventListener('click', processInput);
            clearBtn.addEventListener('click', clearAll);
            copyBtn.addEventListener('click', copyToClipboard);
            downloadBtn.addEventListener('click', downloadJson);
            
            // Main function to process the input
            function processInput() {
                const extendedLearningsText = document.getElementById('extendedLearnings').value;
                const existingClassesText = document.getElementById('existingClasses').value;
                const messageArea = document.getElementById('messageArea');
                const outputArea = document.getElementById('outputJson');
                const previewArea = document.getElementById('previewArea');
                
                // Clear previous messages
                messageArea.innerHTML = '';
                
                // Validate inputs
                if (!extendedLearningsText.trim() || !existingClassesText.trim()) {
                    showError("Please provide both JSON inputs.");
                    return;
                }
                
                try {
                    // Parse the extended class learnings
                    let extendedLearnings;
                    if (extendedLearningsText.includes('const classLearnings =') || 
                        extendedLearningsText.includes('export default')) {
                        // Extract JSON from JavaScript code
                        const jsonStartIndex = extendedLearningsText.indexOf('{');
                        const jsonEndIndex = extendedLearningsText.lastIndexOf('}') + 1;
                        const jsonStr = extendedLearningsText.substring(jsonStartIndex, jsonEndIndex);
                        extendedLearnings = JSON.parse(jsonStr);
                    } else {
                        // Assume it's pure JSON
                        extendedLearnings = JSON.parse(extendedLearningsText);
                    }
                    
                    // Parse the existing classes
                    let existingClasses;
                    if (existingClassesText.startsWith('[')) {
                        // It's an array
                        existingClasses = JSON.parse(existingClassesText);
                    } else {
                        // It's a single class object
                        existingClasses = [JSON.parse(existingClassesText)];
                    }
                    
                    // Process and integrate the data
                    const integratedClasses = integrateClassLearnings(extendedLearnings, existingClasses);
                    
                    // Display the result
                    outputArea.value = JSON.stringify(integratedClasses, null, 2);
                    
                    // Generate preview
                    generatePreview(integratedClasses, existingClasses, extendedLearnings);
                    
                    // Show success message
                    showSuccess(`Successfully integrated learnings for ${integratedClasses.length} classes!`);
                    
                    // Switch to preview tab
                    document.querySelector('.tab[data-tab="preview"]').click();
                } catch (error) {
                    showError(`Error processing JSON: ${error.message}`);
                    console.error(error);
                }
            }
            
            // Function to integrate class learnings
            function integrateClassLearnings(extendedLearnings, existingClasses) {
                const result = JSON.parse(JSON.stringify(existingClasses)); // Deep copy
                
                for (let i = 0; i < result.length; i++) {
                    const className = result[i].name;
                    
                    // Check if we have extended learnings for this class
                    if (extendedLearnings[className]) {
                        // Create a set of existing skill IDs at each level to avoid duplicates
                        const existingSkills = new Map();
                        result[i].learnings.forEach(learning => {
                            if (!existingSkills.has(learning.level)) {
                                existingSkills.set(learning.level, new Set());
                            }
                            existingSkills.get(learning.level).add(learning.skillId);
                        });
                        
                        // Add extended learnings if they don't already exist
                        extendedLearnings[className].forEach(extendedLearning => {
                            const level = extendedLearning.level;
                            const skillId = extendedLearning.skillId;
                            
                            // Check if this specific skill at this level already exists
                            const levelExists = existingSkills.has(level);
                            const skillExistsAtLevel = levelExists && existingSkills.get(level).has(skillId);
                            
                            if (!skillExistsAtLevel) {
                                // Add the new learning
                                result[i].learnings.push({
                                    level: level,
                                    skillId: skillId,
                                    note: ""
                                });
                                
                                // Update our tracking
                                if (!existingSkills.has(level)) {
                                    existingSkills.set(level, new Set());
                                }
                                existingSkills.get(level).add(skillId);
                            }
                        });
                        
                        // Sort the learnings by level for better organization
                        result[i].learnings.sort((a, b) => {
                            if (a.level !== b.level) {
                                return a.level - b.level;
                            }
                            return a.skillId - b.skillId;
                        });
                    }
                }
                
                return result;
            }
            
            // Function to generate preview
            function generatePreview(integratedClasses, existingClasses, extendedLearnings) {
                const previewArea = document.getElementById('previewArea');
                let previewHtml = '<h3>Integration Summary</h3>';
                
                // Overall stats
                const totalOriginalSkills = existingClasses.reduce((sum, cls) => 
                    sum + cls.learnings.length, 0);
                
                const totalIntegratedSkills = integratedClasses.reduce((sum, cls) => 
                    sum + cls.learnings.length, 0);
                
                previewHtml += `
                <div class="stats">
                    <p><strong>Total Classes:</strong> ${integratedClasses.length}</p>
                    <p><strong>Original Total Skills:</strong> ${totalOriginalSkills}</p>
                    <p><strong>Integrated Total Skills:</strong> ${totalIntegratedSkills}</p>
                    <p><strong>Added Skills:</strong> ${totalIntegratedSkills - totalOriginalSkills}</p>
                </div>
                `;
                
                // Table of class integration details
                previewHtml += '<table><thead><tr><th>Class Name</th><th>Original Skills</th><th>Added Skills</th><th>Total Skills</th><th>Highest Level</th></tr></thead><tbody>';
                
                for (const integratedClass of integratedClasses) {
                    const className = integratedClass.name;
                    const originalClass = existingClasses.find(cls => cls.name === className);
                    const originalSkillCount = originalClass ? originalClass.learnings.length : 0;
                    const totalSkillCount = integratedClass.learnings.length;
                    const addedSkillCount = totalSkillCount - originalSkillCount;
                    
                    // Find highest level skill
                    const highestLevel = integratedClass.learnings.reduce((max, learning) => 
                        Math.max(max, learning.level), 0);
                    
                    previewHtml += `
                    <tr>
                        <td>${className}</td>
                        <td>${originalSkillCount}</td>
                        <td>${addedSkillCount}</td>
                        <td>${totalSkillCount}</td>
                        <td>${highestLevel}</td>
                    </tr>
                    `;
                }
                
                previewHtml += '</tbody></table>';
                
                // Detailed skill breakdown for each class
                previewHtml += '<h3>Detailed Skill Breakdown</h3>';
                
                for (const integratedClass of integratedClasses) {
                    const className = integratedClass.name;
                    
                    previewHtml += `<h4>${className}</h4>`;
                    previewHtml += '<table><thead><tr><th>Level</th><th>Skill ID</th><th>Status</th></tr></thead><tbody>';
                    
                    const originalClass = existingClasses.find(cls => cls.name === className);
                    const originalSkills = originalClass ? 
                        originalClass.learnings.map(l => ({level: l.level, skillId: l.skillId})) : [];
                    
                    // Create a map for easier lookup
                    const originalSkillMap = new Map();
                    originalSkills.forEach(skill => {
                        if (!originalSkillMap.has(skill.level)) {
                            originalSkillMap.set(skill.level, new Set());
                        }
                        originalSkillMap.get(skill.level).add(skill.skillId);
                    });
                    
                    for (const learning of integratedClass.learnings) {
                        const isOriginal = originalSkillMap.has(learning.level) && 
                                        originalSkillMap.get(learning.level).has(learning.skillId);
                        
                        previewHtml += `
                        <tr>
                            <td>${learning.level}</td>
                            <td>${learning.skillId}</td>
                            <td>${isOriginal ? 'Original' : 'Added'}</td>
                        </tr>
                        `;
                    }
                    
                    previewHtml += '</tbody></table>';
                }
                
                previewArea.innerHTML = previewHtml;
            }
            
            // Helper functions
            function showError(message) {
                const messageArea = document.getElementById('messageArea');
                messageArea.innerHTML = `<div class="error">${message}</div>`;
            }
            
            function showSuccess(message) {
                const messageArea = document.getElementById('messageArea');
                messageArea.innerHTML = `<div class="success">${message}</div>`;
            }
            
            function clearAll() {
                document.getElementById('extendedLearnings').value = '';
                document.getElementById('existingClasses').value = '';
                document.getElementById('outputJson').value = '';
                document.getElementById('messageArea').innerHTML = '';
                document.getElementById('previewArea').innerHTML = '<p>Process the data to see preview...</p>';
            }
            
            function copyToClipboard() {
                const outputText = document.getElementById('outputJson');
                outputText.select();
                document.execCommand('copy');
                showSuccess('Output copied to clipboard!');
            }
            
            function downloadJson() {
                const outputText = document.getElementById('outputJson').value;
                if (!outputText) {
                    showError('No data to download.');
                    return;
                }
                
                const blob = new Blob([outputText], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'integrated_classes.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        });
    </script>
</body>
</html>
